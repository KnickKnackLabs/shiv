#!/usr/bin/env bash
#MISE description="Install a tool — from the package index or a local path"
#USAGE arg "<name>" help="Command name (e.g., shimmer, frames) or name and path"
#USAGE arg "[path]" help="Local path to repo (optional — if omitted, clones from package index)"
set -eo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source "$REPO_DIR/lib/shim.sh"

NAME="${usage_name}"
LOCAL_PATH="${usage_path:-}"

if [ -n "$LOCAL_PATH" ]; then
  # Local install — point at an existing repo
  TOOL_PATH="$(cd "$LOCAL_PATH" && pwd)"
else
  # Package install — look up in sources and clone
  GH_REPO=$(shiv_lookup "$NAME")
  if [ -z "$GH_REPO" ]; then
    echo "Error: '$NAME' not found in package index" >&2
    echo ""
    echo "Available packages:"
    shiv_list_sources | while read -r pkg repo; do
      echo "  $pkg → $repo"
    done
    exit 1
  fi

  TOOL_PATH="$SHIV_PACKAGES_DIR/$NAME"

  if [ -d "$TOOL_PATH" ]; then
    echo "Already cloned: $TOOL_PATH"
    echo "Pulling latest..."
    git -C "$TOOL_PATH" pull --ff-only 2>&1 | sed 's/^/  /'
  else
    echo "Cloning $GH_REPO..."
    mkdir -p "$SHIV_PACKAGES_DIR"
    gh repo clone "$GH_REPO" "$TOOL_PATH" 2>&1 | sed 's/^/  /'
  fi

  # Set up dependencies
  echo "Setting up..."
  (cd "$TOOL_PATH" && mise trust -q 2>/dev/null; mise install -q 2>/dev/null) || true
fi

if [ ! -f "$TOOL_PATH/mise.toml" ]; then
  echo "Warning: no mise.toml found at $TOOL_PATH"
fi

shiv_create_shim "$NAME" "$TOOL_PATH"
shiv_register "$NAME" "$TOOL_PATH"

echo ""
echo "✓ Installed: $NAME → $TOOL_PATH"
echo "  Shim: $SHIV_BIN_DIR/$NAME"
echo ""
echo "Reload your shell or run:"
echo "  eval \"\$(mise -C $REPO_DIR run -q shell)\""
